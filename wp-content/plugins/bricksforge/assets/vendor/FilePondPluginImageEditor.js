const Z=e=>e instanceof File,q=e=>/^image/.test(e.type),Q=(e,t,i=[])=>{const o=document.createElement(e),n=Object.getOwnPropertyDescriptors(o.__proto__);for(const e in t)"style"===e?o.style.cssText=t[e]:n[e]&&n[e].set||/textContent|innerHTML/.test(e)||"function"==typeof t[e]?o[e]=t[e]:o.setAttribute(e,t[e]);return i.forEach((e=>o.appendChild(e))),o};let j=null;const w=()=>(null===j&&(j=typeof window<"u"&&typeof window.document<"u"),j),ae=w()&&!!Node.prototype.replaceChildren,se=ae?(e,t)=>e.replaceChildren(t):(e,t)=>{for(;e.lastChild;)e.removeChild(e.lastChild);void 0!==t&&e.append(t)},N=w()&&Q("div",{class:"PinturaMeasure",style:"position:absolute;left:0;top:0;width:99999px;height:0;pointer-events:none;contain:strict;margin:0;padding:0;"});let K;const Ee=e=>(se(N,e),N.parentNode||document.body.append(N),clearTimeout(K),K=setTimeout((()=>{N.remove()}),500),e);let H=null;const de=()=>(null===H&&(H=w()&&/^((?!chrome|android).)*(safari|iphone|ipad)/i.test(navigator.userAgent)),H),ce=e=>new Promise(((t,i)=>{let o=!1;!e.parentNode&&de()&&(o=!0,e.style.cssText="position:absolute;visibility:hidden;pointer-events:none;left:0;top:0;width:0;height:0;",Ee(e));const n=()=>{const i=e.naturalWidth,n=e.naturalHeight;i&&n&&(o&&e.remove(),clearInterval(r),t({width:i,height:n}))};e.onerror=e=>{clearInterval(r),i(e)};const r=setInterval(n,1);n()})),le=e=>new Promise(((t,i)=>{const o=()=>{t({width:e.videoWidth,height:e.videoHeight})};if(e.readyState>=1)return o();e.onloadedmetadata=o,e.onerror=()=>i(e.error)})),_e=e=>"string"==typeof e,Ie=e=>new Promise((t=>{const i=_e(e)?e:URL.createObjectURL(e),o=()=>{const e=new Image;e.src=i,t(e)};if(e instanceof Blob&&q(e))return o();const n=document.createElement("video");n.preload="metadata",n.onloadedmetadata=()=>t(n),n.onerror=o,n.src=i})),Te=e=>"VIDEO"===e.nodeName,ue=async e=>{let t,i;t=e.src?e:await Ie(e);try{i=Te(t)?await le(t):await ce(t)}finally{Z(e)&&URL.revokeObjectURL(t.src)}return i},fe=e=>e instanceof Blob&&!(e instanceof File),Y=(...e)=>{},ee=e=>{e.width=1,e.height=1;const t=e.getContext("2d");t&&t.clearRect(0,0,1,1)};let W=null;const ge=()=>{if(null===W)if("WebGL2RenderingContext"in window){let e;try{e=Q("canvas"),W=!!e.getContext("webgl2")}catch{W=!1}e&&ee(e),e=void 0}else W=!1;return W},me=(e,t)=>ge()?e.getContext("webgl2",t):e.getContext("webgl",t)||e.getContext("experimental-webgl",t);let k=null;const pe=()=>{if(null===k){let e=Q("canvas");k=!!me(e),ee(e),e=void 0}return k},Oe=()=>"[object OperaMini]"===Object.prototype.toString.call(window.operamini),Re=()=>"Promise"in window,he=()=>"URL"in window&&"createObjectURL"in window.URL,Ge=()=>"visibilityState"in document,Ae=()=>"performance"in window,Me=()=>"File"in window;let z=null;const X=()=>(null===z&&(z=w()&&!Oe()&&Ge()&&Re()&&Me()&&he()&&Ae()),z),Se=e=>{const{addFilter:t,utils:i,views:o}=e,{Type:n,createRoute:r}=i,{fileActionButton:a}=o,E=(({parallel:e=1,autoShift:t=!0})=>{const i=[];let o=0;const n=()=>{if(!i.length)return a.oncomplete();o++,i.shift()((()=>{o--,o<e&&r()}))},r=()=>{for(let t=0;t<e-o;t++)n()},a={queue:e=>{i.push(e),t&&r()},runJobs:r,oncomplete:()=>{}};return a})({parallel:1}),d=e=>null===e?{}:e;t("SHOULD_REMOVE_ON_REVERT",((e,{item:t,query:i})=>new Promise((e=>{const{file:o}=t;e(!(i("GET_ALLOW_IMAGE_EDITOR")&&i("GET_IMAGE_EDITOR_ALLOW_EDIT")&&i("GET_IMAGE_EDITOR_SUPPORT_EDIT")&&i("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(o)))})))),t("DID_LOAD_ITEM",((e,{query:t,dispatch:i})=>new Promise(((o,n)=>{if(e.origin>1)return void o(e);const{file:r}=e;if(!t("GET_ALLOW_IMAGE_EDITOR")||!t("GET_IMAGE_EDITOR_INSTANT_EDIT")||!t("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(r))return o(e);const a=()=>{if(!s.length)return;const{item:e,resolve:t,reject:o}=s[0];i("EDIT_ITEM",{id:e.id,handleEditorResponse:E(e,t,o)})},E=(e,t,o)=>n=>{s.shift(),n?t(e):o(e),i("KICK"),a()};l({item:e,resolve:o,reject:n}),1===s.length&&a()})))),t("DID_CREATE_ITEM",((e,{query:t,dispatch:i})=>{e.getMetadata("color")&&e.setMetadata("colors",e.getMetadata("color")),e.extend("edit",(()=>{i("EDIT_ITEM",{id:e.id})}))}));const s=[],l=e=>(s.push(e),e),_=(e,t,i=()=>{})=>{if(!t)return;if(!e("GET_FILE_POSTER_FILTER_ITEM")(t))return i();const{imageProcessor:o,imageReader:n,imageWriter:r,editorOptions:a,legacyDataToImageState:s,imageState:l}=d(e("GET_IMAGE_EDITOR"));if(!o)return;const[_,T]=n,[c=Y,I]=r,m=t.file,u=t.getMetadata("imageState"),g=((e,t)=>{const i=e("GET_FILE_POSTER_HEIGHT"),o=e("GET_FILE_POSTER_MAX_HEIGHT");return i?(t.width=2*i,t.height=2*i):o&&(t.width=2*o,t.height=2*o),t})(e,{width:512,height:512}),O={...a,imageReader:_(T),imageWriter:c({...I||{},canvasMemoryLimit:g.width*g.height*2,preprocessImageState:(e,i,o,n)=>!u&&s?{...e,...s(void 0,n.size,{...t.getMetadata()})}:e}),imageState:{...l,...u}};E.queue((e=>{o(m,O).then((({dest:o})=>{t.setMetadata("poster",URL.createObjectURL(o),!0),e(),i()}))}))};t("CREATE_VIEW",(e=>{const{is:t,view:i,query:o}=e;if(!o("GET_ALLOW_IMAGE_EDITOR")||!o("GET_IMAGE_EDITOR_SUPPORT_WRITE_IMAGE"))return;const n=o("GET_ALLOW_FILE_POSTER");if(!(t("file-info")&&!n||t("file")&&n))return;const{createEditor:E,imageReader:s,imageWriter:l,editorOptions:T,legacyDataToImageState:c,imageState:I}=d(o("GET_IMAGE_EDITOR"));if(!(s&&l&&T&&T.locale))return;delete T.imageReader,delete T.imageWriter;const[m,u]=s,g=e=>{const{id:t}=e;return o("GET_ITEM",t)},O=(e,t)=>{if(e.ref.handleEdit||(e.ref.handleEdit=i=>{i.stopPropagation(),e.dispatch("EDIT_ITEM",{id:t.id})}),(e=>{if(!o("GET_ALLOW_FILE_POSTER"))return!1;const t=g(e);return t?!!o("GET_FILE_POSTER_FILTER_ITEM")(t)&&!!t.getMetadata("poster"):void 0})(t)){e.ref.editButton&&e.ref.editButton.parentNode&&e.ref.editButton.parentNode.removeChild(e.ref.editButton);const t=i.createChildView(a,{label:"edit",icon:o("GET_IMAGE_EDITOR_ICON_EDIT"),opacity:0});t.element.classList.add("filepond--action-edit-item"),t.element.dataset.align=o("GET_STYLE_IMAGE_EDITOR_BUTTON_EDIT_ITEM_POSITION"),t.on("click",e.ref.handleEdit),e.ref.buttonEditItem=i.appendChildView(t)}else{e.ref.buttonEditItem&&e.removeChildView(e.ref.buttonEditItem);const t=i.element.querySelector(".filepond--file-info-main"),n=document.createElement("button");n.className="filepond--action-edit-item-alt",n.innerHTML=o("GET_IMAGE_EDITOR_ICON_EDIT")+"<span>edit</span>",n.addEventListener("click",e.ref.handleEdit),t.appendChild(n),e.ref.editButton=n}};i.registerDestroyer((({root:e})=>{e.ref.buttonEditItem&&e.ref.buttonEditItem.off("click",e.ref.handleEdit),e.ref.editButton&&e.ref.editButton.removeEventListener("click",e.ref.handleEdit)}));const R={EDIT_ITEM:({root:e,props:t,action:i})=>{const{handleEditorResponse:o}=i,n=g(t),r=n.file,a=E({...T,imageReader:m(u),src:r});a.on("load",(({size:e})=>{let t=n.getMetadata("imageState");!t&&c&&(t=c(a,e,n.getMetadata())),a.imageState={...I,...t}})),a.on("process",(({imageState:e})=>{n.setMetadata("imageState",e),o&&o(!0)})),a.on("close",(()=>{o&&o(!1)}))},DID_LOAD_ITEM:({root:e,props:t})=>{const{id:i}=t,n=o("GET_ITEM",i);if(!n)return;const r=n.file;o("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(r)&&(o("GET_ALLOW_FILE_POSTER")&&!n.getMetadata("poster")&&e.dispatch("REQUEST_CREATE_IMAGE_POSTER",{id:i}),o("GET_IMAGE_EDITOR_ALLOW_EDIT")&&o("GET_IMAGE_EDITOR_SUPPORT_EDIT")&&O(e,t))},DID_UPDATE_ITEM_METADATA:({root:e,props:t,action:i})=>{if(/imageState/.test(i.change.key)&&o("GET_ALLOW_FILE_POSTER"))return e.dispatch("REQUEST_CREATE_IMAGE_POSTER",{id:t.id});/poster/.test(i.change.key)&&(!o("GET_IMAGE_EDITOR_ALLOW_EDIT")||!o("GET_IMAGE_EDITOR_SUPPORT_EDIT")||O(e,t))},DID_REMOVE_ITEM:({props:e})=>{const{id:t}=e,i=o("GET_ITEM",t);if(!i)return;const n=i.getMetadata("poster");n&&URL.revokeObjectURL(n)},REQUEST_CREATE_IMAGE_POSTER:({root:e,props:t})=>_(e.query,g(t)),DID_FILE_POSTER_LOAD:void 0};if(n){const e=({root:e})=>{e.ref.buttonEditItem&&(e.ref.buttonEditItem.opacity=1)};R.DID_FILE_POSTER_LOAD=e}i.registerWriter(r(R))})),t("SHOULD_PREPARE_OUTPUT",((e,{query:t,change:i,item:o})=>new Promise((e=>{if(!t("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(o.file)||i&&!/imageState/.test(i.key))return e(!1);e(!t("IS_ASYNC"))}))));const T=(e,t,i)=>new Promise((o=>{if(!(e=>{const{imageProcessor:t,imageReader:i,imageWriter:o}=d(e("GET_IMAGE_EDITOR"));return e("GET_IMAGE_EDITOR_WRITE_IMAGE")&&e("GET_IMAGE_EDITOR_SUPPORT_WRITE_IMAGE")&&t&&i&&o})(e)||i.archived||!Z(t)&&!fe(t)||!e("GET_IMAGE_EDITOR_SUPPORT_IMAGE")(t))return o(!1);ue(t).then((()=>{const i=e("GET_IMAGE_TRANSFORM_IMAGE_FILTER");if(i){const e=i(t);if("boolean"==typeof e)return o(e);if("function"==typeof e.then)return e.then(o)}o(!0)})).catch((()=>{const i=e("GET_IMAGE_EDITOR_SUPPORT_IMAGE_FORMAT");i&&i(t)?o(!0):o(!1)}))}));return t("PREPARE_OUTPUT",((e,{query:t,item:i})=>new Promise((o=>{T(t,e,i).then((n=>{if(!n)return o(e);(e=>new Promise(((o,n)=>{const r=()=>{E.queue((r=>{const a=i.getMetadata("imageState"),{imageProcessor:E,imageReader:s,imageWriter:l,editorOptions:_,imageState:T}=d(t("GET_IMAGE_EDITOR"));if(!(E&&s&&l&&_))return;const[c,I]=s,[m=Y,u]=l;E(e,{..._,imageReader:c(I),imageWriter:m(u),imageState:{...T,...a}}).then(o).catch(n).finally(r)}))};t("GET_ALLOW_FILE_POSTER")&&!i.getMetadata("poster")?_(t,i,r):r()})))(e).then((e=>{const i=t("GET_IMAGE_EDITOR_AFTER_WRITE_IMAGE");if(i)return Promise.resolve(i(e)).then(o);o(e.dest)}))}))})))),{options:{allowImageEditor:[!0,n.BOOLEAN],imageEditorInstantEdit:[!1,n.BOOLEAN],imageEditorAllowEdit:[!0,n.BOOLEAN],imageEditorSupportEdit:[w()&&X()&&pe(),n.BOOLEAN],imageEditorSupportImage:[q,n.FUNCTION],imageEditorSupportImageFormat:[null,n.FUNCTION],imageEditorSupportWriteImage:[X(),n.BOOLEAN],imageEditorWriteImage:[!0,n.BOOLEAN],imageEditorAfterWriteImage:[void 0,n.FUNCTION],imageEditor:[null,n.OBJECT],imageEditorIconEdit:['<svg width="26" height="26" viewBox="0 0 26 26" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><path d="M8.5 17h1.586l7-7L15.5 8.414l-7 7V17zm-1.707-2.707l8-8a1 1 0 0 1 1.414 0l3 3a1 1 0 0 1 0 1.414l-8 8A1 1 0 0 1 10.5 19h-3a1 1 0 0 1-1-1v-3a1 1 0 0 1 .293-.707z" fill="currentColor" fill-rule="nonzero"/></svg>',n.STRING],styleImageEditorButtonEditItemPosition:["bottom center",n.STRING]}}};w()&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:Se}));export{Se as default};