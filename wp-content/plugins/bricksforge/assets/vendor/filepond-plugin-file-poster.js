/*! For license information please see filepond-plugin-file-poster.js.LICENSE.txt */
const IMAGE_SCALE_SPRING_PROPS={type:"spring",stiffness:.5,damping:.45,mass:10},createPosterView=e=>e.utils.createView({name:"file-poster",tag:"div",ignoreRect:!0,create:({root:e})=>{e.ref.image=document.createElement("img"),e.element.appendChild(e.ref.image)},write:e.utils.createRoute({DID_FILE_POSTER_LOAD:({root:e,props:t})=>{const{id:r}=t,a=e.query("GET_ITEM",{id:t.id});if(!a)return;const o=a.getMetadata("poster");e.ref.image.src=o,e.dispatch("DID_FILE_POSTER_DRAW",{id:r})}}),mixins:{styles:["scaleX","scaleY","opacity"],animations:{scaleX:IMAGE_SCALE_SPRING_PROPS,scaleY:IMAGE_SCALE_SPRING_PROPS,opacity:{type:"tween",duration:750}}}}),applyTemplate=(e,t)=>{t.width=e.width,t.height=e.height;t.getContext("2d").drawImage(e,0,0)},createPosterOverlayView=e=>e.utils.createView({name:"file-poster-overlay",tag:"canvas",ignoreRect:!0,create:({root:e,props:t})=>{applyTemplate(t.template,e.element)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}}),getImageSize=(e,t)=>{let r=new Image;r.onload=()=>{const e=r.naturalWidth,a=r.naturalHeight;r=null,t(e,a)},r.src=e},easeInOutSine=e=>-.5*(Math.cos(Math.PI*e)-1),addGradientSteps=(e,t,r=1,a=easeInOutSine,o=10,i=0)=>{const l=1-i,s=t.join(",");for(let t=0;t<=o;t++){const c=t/o,n=i+l*c;e.addColorStop(n,`rgba(${s}, ${a(c)*r})`)}},MAX_WIDTH=10,MAX_HEIGHT=10,calculateAverageColor=e=>{const t=Math.min(10/e.width,10/e.height),r=document.createElement("canvas"),a=r.getContext("2d"),o=r.width=Math.ceil(e.width*t),i=r.height=Math.ceil(e.height*t);a.drawImage(e,0,0,o,i);let l=null;try{l=a.getImageData(0,0,o,i).data}catch(e){return null}const s=l.length;let c=0,n=0,E=0,d=0;for(;d<s;d+=4)c+=l[d]*l[d],n+=l[d+1]*l[d+1],E+=l[d+2]*l[d+2];return c=averageColor(c,s),n=averageColor(n,s),E=averageColor(E,s),{r:c,g:n,b:E}},averageColor=(e,t)=>Math.floor(Math.sqrt(e/(t/4))),drawTemplate=(e,t,r,a,o)=>{e.width=t,e.height=r;const i=e.getContext("2d"),l=.5*t,s=i.createRadialGradient(l,r+110,r-100,l,r+110,r+100);addGradientSteps(s,a,o,void 0,8,.4),i.save(),i.translate(.5*-t,0),i.scale(2,1),i.fillStyle=s,i.fillRect(0,0,t,r),i.restore()},hasNavigator="undefined"!=typeof navigator,width=500,height=200,overlayTemplateShadow=hasNavigator&&document.createElement("canvas"),overlayTemplateError=hasNavigator&&document.createElement("canvas"),overlayTemplateSuccess=hasNavigator&&document.createElement("canvas");let itemShadowColor=[40,40,40],itemErrorColor=[196,78,71],itemSuccessColor=[54,151,99];hasNavigator&&(drawTemplate(overlayTemplateShadow,500,200,itemShadowColor,.85),drawTemplate(overlayTemplateError,500,200,itemErrorColor,1),drawTemplate(overlayTemplateSuccess,500,200,itemSuccessColor,1));const loadImage=(e,t)=>new Promise(((r,a)=>{const o=new Image;"string"==typeof crossOrigin&&(o.crossOrigin=t),o.onload=()=>{r(o)},o.onerror=e=>{a(e)},o.src=e})),createPosterWrapperView=e=>{const t=createPosterOverlayView(e),r=({root:e})=>{e.ref.overlayShadow.opacity=1,e.ref.overlayError.opacity=0,e.ref.overlaySuccess.opacity=0},a=({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlayError.opacity=1};return e.utils.createView({name:"file-poster-wrapper",create:({root:r,props:a})=>{const o=r.query("GET_FILE_POSTER_ITEM_OVERLAY_SHADOW_COLOR"),i=r.query("GET_FILE_POSTER_ITEM_OVERLAY_ERROR_COLOR"),l=r.query("GET_FILE_POSTER_ITEM_OVERLAY_SUCCESS_COLOR");o&&o!==itemShadowColor&&(itemShadowColor=o,drawTemplate(overlayTemplateShadow,500,200,itemShadowColor,.85)),i&&i!==itemErrorColor&&(itemErrorColor=i,drawTemplate(overlayTemplateError,500,200,itemErrorColor,1)),l&&l!==itemSuccessColor&&(itemSuccessColor=l,drawTemplate(overlayTemplateSuccess,500,200,itemSuccessColor,1));const s=createPosterView(e);r.ref.image=r.appendChildView(r.createChildView(s,{id:a.id,scaleX:1.25,scaleY:1.25,opacity:0})),r.ref.overlayShadow=r.appendChildView(r.createChildView(t,{template:overlayTemplateShadow,opacity:0})),r.ref.overlaySuccess=r.appendChildView(r.createChildView(t,{template:overlayTemplateSuccess,opacity:0})),r.ref.overlayError=r.appendChildView(r.createChildView(t,{template:overlayTemplateError,opacity:0}))},write:e.utils.createRoute({DID_FILE_POSTER_LOAD:({root:e})=>{e.ref.overlayShadow.opacity=1},DID_FILE_POSTER_DRAW:({root:e})=>{const{image:t}=e.ref;t.scaleX=1,t.scaleY=1,t.opacity=1},DID_FILE_POSTER_CONTAINER_CREATE:({root:e,props:t})=>{const{id:r}=t,a=e.query("GET_ITEM",r);if(!a)return;const o=a.getMetadata("poster"),i=t=>{const o=e.query("GET_FILE_POSTER_CALCULATE_AVERAGE_IMAGE_COLOR")?calculateAverageColor(t):null;a.setMetadata("color",o,!0),e.dispatch("DID_FILE_POSTER_LOAD",{id:r,data:t})};getImageSize(o,((t,a)=>{e.dispatch("DID_FILE_POSTER_CALCULATE_SIZE",{id:r,width:t,height:a}),loadImage(o,e.query("GET_FILE_POSTER_CROSS_ORIGIN_ATTRIBUTE_VALUE")).then(i)}))},DID_THROW_ITEM_LOAD_ERROR:a,DID_THROW_ITEM_PROCESSING_ERROR:a,DID_THROW_ITEM_INVALID:a,DID_COMPLETE_ITEM_PROCESSING:({root:e})=>{e.ref.overlayShadow.opacity=.25,e.ref.overlaySuccess.opacity=1},DID_START_ITEM_PROCESSING:r,DID_REVERT_ITEM_PROCESSING:r})})},plugin=e=>{const{addFilter:t,utils:r}=e,{Type:a,createRoute:o}=r,i=createPosterWrapperView(e);return t("CREATE_VIEW",(e=>{const{is:t,view:r,query:a}=e;if(!t("file")||!a("GET_ALLOW_FILE_POSTER"))return;const l=(e,t)=>{const{id:o}=t,l=a("GET_ITEM",o);l&&l.getMetadata("poster")&&!l.archived&&e.ref.previousPoster!==l.getMetadata("poster")&&(e.ref.previousPoster=l.getMetadata("poster"),a("GET_FILE_POSTER_FILTER_ITEM")(l)&&(e.ref.filePoster&&r.removeChildView(e.ref.filePoster),e.ref.filePoster=r.appendChildView(r.createChildView(i,{id:o})),e.dispatch("DID_FILE_POSTER_CONTAINER_CREATE",{id:o})))},s=({root:e})=>{let t=e.query("GET_FILE_POSTER_HEIGHT");if(t)return t;const r=e.query("GET_FILE_POSTER_MIN_HEIGHT"),a=e.query("GET_FILE_POSTER_MAX_HEIGHT");if(r&&e.ref.imageHeight<r)return r;let o=e.rect.element.width*(e.ref.imageHeight/e.ref.imageWidth);return r&&o<r?r:a&&o>a?a:o};r.registerWriter(o({DID_LOAD_ITEM:({root:e,props:t})=>{l(e,t)},DID_FILE_POSTER_CALCULATE_SIZE:({root:e,action:t})=>{e.ref.filePoster&&(e.ref.imageWidth=t.width,e.ref.imageHeight=t.height,e.ref.shouldUpdatePanelHeight=!0,e.dispatch("KICK"))},DID_UPDATE_ITEM_METADATA:({root:e,props:t,action:r})=>{/poster/.test(r.change.key)&&l(e,t)}},(({root:e,props:t})=>{e.ref.filePoster&&(e.rect.element.hidden||e.ref.shouldUpdatePanelHeight&&(e.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:t.id,height:s({root:e})}),e.ref.shouldUpdatePanelHeight=!1))})))})),{options:{allowFilePoster:[!0,a.BOOLEAN],filePosterHeight:[null,a.INT],filePosterMinHeight:[null,a.INT],filePosterMaxHeight:[null,a.INT],filePosterFilterItem:[()=>!0,a.FUNCTION],filePosterCalculateAverageImageColor:[!1,a.BOOLEAN],filePosterCrossOriginAttributeValue:["Anonymous",a.STRING],filePosterItemOverlayShadowColor:[null,a.ARRAY],filePosterItemOverlayErrorColor:[null,a.ARRAY],filePosterItemOverlaySuccessColor:[null,a.ARRAY]}}},isBrowser="undefined"!=typeof window&&void 0!==window.document;isBrowser&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:plugin}));export default plugin;