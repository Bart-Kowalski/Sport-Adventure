!function(e){"use strict";e.WS_Form.prototype.form_google_route=async function(){var a=this;if(!1===await this.form_google_maps_js_api_await("googleroute"))return!1;await this.form_google_maps_js_api_import_libraries("googleroute");var t=e("[data-google-distance]:not([data-init-google-route])",this.form_canvas_obj);if(!t.length)return!1;t.each(function(){e(this).attr("data-init-google-route",""),e(this).val(0);var t={},o=a.get_field(e(this));t.obj=this,t.field_id=a.get_field_id(e(this)),t.field_id_origin=a.get_object_meta_value(o,"google_route_field_id_origin",!1),t.waypoints=a.get_object_meta_value(o,"google_route_waypoints",!1),t.waypoints_optimize=a.get_object_meta_value(o,"google_route_waypoints_optimize",!1),t.field_id_destination=a.get_object_meta_value(o,"google_route_field_id_destination",!1),t.field_mapping=a.get_object_meta_value(o,"google_route_field_mapping",[]),t.travel_mode=a.get_object_meta_value(o,"google_route_travel_mode","DRIVING"),t.unit_system=a.get_object_meta_value(o,"google_route_unit_system","METRIC"),t.avoid_highways=a.get_object_meta_value(o,"google_route_avoid_highways",""),t.avoid_tolls=a.get_object_meta_value(o,"google_route_avoid_tolls",""),t.avoid_ferries=a.get_object_meta_value(o,"google_route_avoid_ferries",""),t.map_field_id=a.get_object_meta_value(o,"google_route_map",""),a.google_route_process(t)})},e.WS_Form.prototype.google_route_process=function(a,t){var o=this;if(a.reposition=!0,!(a.field_id_origin&&a.field_id_destination&&["BICYCLING","DRIVING","TRANSIT","WALKING"].includes(a.travel_mode)&&["METRIC","IMPERIAL"].includes(a.unit_system)))return this.error("error_google_route"),!1;var i=function(a){var t=a.data.google_route,i=e(t.obj),r=a.data.obj_origin,_=a.data.obj_destination,s=a.data.waypoints,n=void 0!==r.attr("data-place-id")&&r.attr("data-place-id"),l=void 0!==_.attr("data-place-id")&&_.attr("data-place-id"),d=r.val(),g=_.val();if(n)var c={placeId:n};else{if(""==d)return!1;c=o.google_route_get_origin_destination(d)}if(l)var f={placeId:l};else{if(""==g)return!1;f=o.google_route_get_origin_destination(g)}var p=[];for(var u in s)if(s.hasOwnProperty(u)){var v=s[u],m=v.selector;e(m).each(function(){var a=void 0!==e(this).attr("data-place-id")&&e(this).attr("data-place-id"),t=e(this).val();if(a)var i={location:{placeId:a}};else{if(""==t)return;i={location:o.google_route_get_origin_destination(t)}}switch(v.type){case"stopover_true":i.stopover=!0;break;case"stopover_false":i.stopover=!1}p.push(i)})}try{var b=new google.maps.DirectionsService,h={origin:c,destination:f,travelMode:t.travel_mode,unitSystem:google.maps.UnitSystem[t.unit_system],avoidFerries:"on"==t.avoid_ferries,avoidHighways:"on"==t.avoid_highways,avoidTolls:"on"==t.avoid_tolls};p.length&&(h.waypoints=p,t.waypoints_optimize&&(h.optimizeWaypoints=!0)),b.route(h,function(a,r){switch(r){case"OK":var _=a.routes[0],s=a.routes[0].legs,n=s.length,l=0,d=0,g="",c="",f="",p="",u="",v="";for(var m in s)if(s.hasOwnProperty(m)){var b=s[m];l+=b.distance.value,d+=b.duration.value,0==m&&(g=b.start_address,c=b.start_location.lat(),f=b.start_location.lng()),m==n-1&&(p=b.end_address,u=b.end_location.lat(),v=b.end_location.lng())}var h=o.get_nice_distance(l,t.unit_system),y=o.get_nice_duration(d,!1);if("object"==typeof t.field_mapping&&t.field_mapping.length)for(var w in t.field_mapping)if(t.field_mapping.hasOwnProperty(w)){var j=t.field_mapping[w],k=void 0!==j.google_route_element?j.google_route_element:"";if(""!=k){var x="";switch(k){case"distance_text":x=h;break;case"distance_value_metric":x=l;break;case"distance_value_metric_km":x=l/1e3;break;case"distance_value_imperial":x=l/1609;break;case"distance_value_imperial_yard":x=l/1609*1760;break;case"duration_text":x=y;break;case"duration_value":x=d;break;case"duration_value_minute":x=d/60;break;case"duration_value_hour":x=d/3600;break;case"duration_value_day":x=d/86400;break;case"duration_value_week":x=d/604800;break;case"duration_value_year":x=d/31536e3;break;case"start_address":x=g;break;case"start_lat":x=c;break;case"start_lng":x=f;break;case"start_lat_lng":x=c+","+f;break;case"end_address":x=p;break;case"end_lat":x=u;break;case"end_lng":x=v;break;case"end_lat_lng":x=u+","+v;break;case"summary":x=_.summary}var I=parseInt(void 0!==j.ws_form_field?j.ws_form_field:"",10);if(0!=I){var O=o.get_section_repeatable_suffix(e(t.obj)),S=e("#"+o.form_id_prefix+"field-wrapper-"+I+O,o.form_canvas_obj),F=e("#"+o.form_id_prefix+"field-"+I+O,o.form_canvas_obj);o.field_value_set(S,F,x)}}}O=o.get_section_repeatable_suffix(e(i));if(""!=t.map_field_id&&void 0!==o.google_maps[t.map_field_id+O]){var R=o.google_maps[t.map_field_id+O];o.google_map_directions_renderer_init(R),R.directions_renderer.setDirections(a)}break;default:o.error("error_google_route_message",JSON.stringify(a))}i.attr("data-google-route-status",r).trigger("wsf-google-route")})}catch(e){o.error("error_google_route_message",e)}},r=function(a){var t=a.data.google_route,i=e(t.obj);a.data.obj_origin,a.data.obj_destination;if(i.removeAttr("data-place-id"),"object"==typeof t.field_mapping&&t.field_mapping.length)for(var r in t.field_mapping)if(t.field_mapping.hasOwnProperty(r)){var _=t.field_mapping[r],s=void 0!==_.google_route_element?_.google_route_element:"";if(""!=s){var n="";switch(s){case"distance_text":case"duration_text":case"start_address":case"start_lat":case"start_lng":case"start_lat_lng":case"end_address":case"end_lat":case"end_lng":case"end_lat_lng":case"summary":n="";break;case"distance_value_metric":case"distance_value_metric_km":case"distance_value_imperial":case"distance_value_imperial_yard":case"duration_value":case"duration_value_minute":case"duration_value_hour":case"duration_value_day":case"duration_value_week":case"duration_value_year":n=0}var l=parseInt(void 0!==_.ws_form_field?_.ws_form_field:"",10);if(0!=l){var d=o.get_section_repeatable_suffix(e(t.obj)),g=e("#"+o.form_id_prefix+"field-wrapper-"+l+d,o.form_canvas_obj);i=e("#"+o.form_id_prefix+"field-"+l+d,o.form_canvas_obj);o.field_value_set(g,i,n)}}}if(""!=t.map_field_id&&void 0!==o.google_maps[t.map_field_id]){var c=o.google_maps[t.map_field_id];o.google_map_directions_renderer_init(c),c.directions_renderer.set("directions",null)}},_=o.get_section_repeatable_suffix(e(a.obj)),s=e("#"+o.form_id_prefix+"field-"+a.field_id_origin+_,o.form_canvas_obj),n=e("#"+o.form_id_prefix+"field-"+a.field_id_destination+_,o.form_canvas_obj);if(!s.length||!n.length)return this.error("error_google_route"),!1;var l=this.get_field_type(s),d=this.get_field_type(n),g={google_route:a,obj_origin:s,obj_destination:n};"googleaddress"===l?(s.on("wsf-place-id-reset",g,r),s.on("wsf-place-id-set",g,i)):(s.on("change",g,r),s.on("change",g,i)),"googleaddress"===d?(n.on("wsf-place-id-reset",g,r),n.on("wsf-place-id-set",g,i)):(n.on("change",g,r),n.on("change",g,i));var c=[];for(var f in a.waypoints)if(a.waypoints.hasOwnProperty(f)){var p=a.waypoints[f],u=p.google_route_waypoint_field_id,v=p.google_route_waypoint_type;if(void 0!==this.field_data_cache[u]){var m=this.field_data_cache[u];if(m.section_repeatable)var b='[id^="'+this.esc_selector(this.form_id_prefix+"field-"+u)+'-repeat-"]';else b="#"+this.esc_selector(this.form_id_prefix+"field-"+u);"googleaddress"===m.type?(this.form_canvas_obj.on("wsf-place-id-reset",b,g,i),this.form_canvas_obj.on("wsf-place-id-set",b,g,i)):(this.form_canvas_obj.on("change",b,g,r),this.form_canvas_obj.on("change",b,g,i));var h=void 0!==m.section_repeatable_section_id&&m.section_repeatable_section_id;h&&this.form_canvas_obj.on("wsf-section-repeatable-delete-"+h+" wsf-section-repeatable-move-"+h,g,i),c.push({field_id:u,type:v,selector:b})}}g.waypoints=c,r({data:g}),"googleaddress"!==l&&"googleaddress"!==d&&i({data:g})},e.WS_Form.prototype.google_map_directions_renderer_init=function(e){if(!1===e.directions_renderer){var a={polylineOptions:{strokeColor:e.routing_polyline_color,strokeWeight:e.routing_polyline_weight}};e.routing_icon_url_origin&&(a.markerOptions={icon:{url:e.routing_icon_url_origin}}),e.directions_renderer=new google.maps.DirectionsRenderer(a),e.directions_renderer.setMap(e.map)}},e.WS_Form.prototype.google_route_get_origin_destination=function(e){if(null!==/^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?),\s*[-+]?(180(\.0+)?|((1[0-7]\d)|([1-9]?\d))(\.\d+)?)$/.exec(e)){var a=e.split(",");return{lat:parseFloat(a[0]),lng:parseFloat(a[1])}}return e}}(jQuery);