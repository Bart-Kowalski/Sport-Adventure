!function(e){"use strict";e.WS_Form.prototype.form_file=function(){var t=this;e('input[type="file"]:not([data-init-file])',this.form_canvas_obj).each(function(){var a=t.get_field(e(this)),i=!1;if("on"===t.get_object_meta_value(a,"file_preview",!1)){var r=t.get_object_meta_value(a,"orientation",!1),o=ws_form_settings.skin_grid_gutter;switch(r){case"grid":var s=t.get_field_value_fallback(a.type,!1,"class_orientation_wrapper",[]),l=t.get_field_value_fallback(a.type,!1,"class_orientation_row",[]);s.push("wsf-file-preview");var n=s.join(" "),_=t.column_class_array(a,"orientation_breakpoint"),d=(_=l.concat(_)).join(" "),p="",c="display: block; height: revert; margin-top: "+o+"px; width: 100%;";break;case"horizontal":n="wsf-file-preview",d="";var f=t.get_object_meta_value(a,"file_preview_width",!1);p="display: inline-block; -webkit-margin-end: "+o+"px; margin-inline-end: "+o+"px; vertical-align: top;"+(!1!==f?" width: "+f+";":""),c="display: block; height: revert; margin-top: "+o+"px; max-width: 100%; width: revert;";break;default:n="wsf-file-preview",d="",p="",c="display: block; height: revert; margin-top: "+o+"px; max-width: 100%; width: 100%;"}i=e("<div"+(""!=n?' class="'+t.esc_attr(n)+'"':"")+"></div>");e(this).closest("[data-type]").append(i)}e(this).on("change",function(){var a=e(this)[0].files;!1!==i&&t.form_file_preview(a,i,d,p,c)}),e(this).attr("data-init-file","")}),"undefined"!=typeof Dropzone&&e('[data-file-type="dropzonejs"]:not([data-init-file])',this.form_canvas_obj).each(function(){var a=t.get_field_id(e(this)),i=t.get_field(e(this));Dropzone.autoDiscover=!1;var r=e(this),o=e(this).attr("id"),s=void 0!==e(this).attr("multiple"),l=t.get_object_meta_value(i,"dropzonejs_dict_invalid_file_type",""),n=t.get_object_meta_value(i,"dropzonejs_dict_max_file_count",""),_=t.get_object_meta_value(i,"dropzonejs_dict_max_file_size",""),d=t.get_object_meta_value(i,"dropzonejs_dict_cancel_upload",""),p=t.get_object_meta_value(i,"dropzonejs_dict_cancel_upload_confirm",""),c=t.get_object_meta_value(i,"dropzonejs_dict_cancel_upload_done",""),f=t.get_object_meta_value(i,"dropzonejs_dict_remove_file",""),v=t.get_object_meta_value(i,"dropzonejs_dict_remove_file_confirm",""),u=e('[data-source="post_progress"]',this.form_canvas_obj),m=t.get_object_meta_value(i,"orientation",!1),h=null,g=null,w=ws_form_settings.skin_grid_gutter;switch(m){case"grid":var b=t.get_field_value_fallback("file",!1,"class_orientation_wrapper",[]);b.push("wsf-dropzonejs-previews");var j=b.join(" "),z=t.get_field_value_fallback("file",!1,"class_orientation_row",[]),y=t.column_class_array(i,"orientation_breakpoint");(y=z.concat(y)).push("wsf-dropzonejs-preview");var k=y.join(" "),x="margin-bottom: "+w+"px;",F="display: block; height: revert; width: 100%;";break;case"horizontal":j="wsf-dropzonejs-previews",k="wsf-dropzonejs-preview";var O=t.get_object_meta_value(i,"file_preview_width",!1),S=(x="display: inline-block; margin-bottom: "+w+"px; -webkit-margin-end: "+w+"px; margin-inline-end: "+w+"px; vertical-align: top;"+(!1!==O?" width: "+O+";":""),F="display: block; width: revert; height: revert; max-width: 100%;",parseInt(t.replace_all(O,"px",""),10));h=S,g=S;break;default:j="wsf-dropzonejs-previews",k="wsf-dropzonejs-preview",x="margin-bottom: "+w+"px;",F="display: block; height: revert; max-width: 100%; width: 100%;"}e("#"+o+"-dropzonejs-previews").attr("class",j);var L=t.get_field_value_fallback("file",!1,"mask_invalid_feedback_dropzonejs_preview",""),C=[];C.invalid_feedback_id="#"+o+"-dropzone-error-message";var T=t.get_field_value_fallback("file",!1,"class_invalid_feedback",[]);C.invalid_feedback_class=T.join(" "),C.invalid_feedback="",C.attributes=" data-dz-errormessage";var U=t.mask_parse(L,C),I=t.get_field_value_fallback("file",!1,"mask_help_dropzonejs_preview",""),R=[];R.help_id="#"+o+"-dropzone-name";var D=t.get_field_value_fallback("file",!1,"class_help_post",[]);R.help_class=D.join(" "),R.help="",R.help_append="",R.attributes=" data-dz-name";var M=t.mask_parse(I,R);R.attributes=" data-dz-size";var W=t.mask_parse(I,R);R.attributes="",R.help='<a href="#" data-dz-remove>'+(f||t.language("dropzonejs_remove"))+"</a>";var H=t.mask_parse(I,R),N='<div class="'+(k?" "+t.esc_attr(k):"")+(""!=x?'" style="'+t.esc_attr(x)+'"':"")+'">';N+='<img data-dz-thumbnail style="'+(F?" "+F:"")+'" />',N+=U,N+=M,N+=W,N+='<div class="wsf-progress"><div class="wsf-upload" data-dz-uploadprogress></div></div>',N+=H,N+="</div>";var E={url:ws_form_settings.url_ajax+"field/"+a+"/dropzonejs/",paramName:"file",uploadMultiple:s,previewTemplate:N,previewsContainer:"#"+o+"-dropzonejs-previews",thumbnailWidth:h,thumbnailHeight:g,init:function(){this.add_custom_file=function(e,t,a){this.files.push(e),this.emit("addedfile",e),this.emit("thumbnail",e,t),this.emit("processing",e),this.emit("success",e,a,!1),this.emit("complete",e),this.element.classList.add("dz-started")},this.ajax_complete=function(a){t.dropzonejs_processes>0&&t.dropzonejs_processes--,0===t.dropzonejs_processes&&(t.form_post_unlock("progress",!1,!0),u.each(function(){t.form_progress_set_value(e(this),0)})),e("[data-dz-remove]",e(a.previewTemplate)).html(f||t.language("dropzonejs_remove"))},this.input_update=function(){var e={};for(var t in Z.files)if(Z.files.hasOwnProperty(t)){var a=Z.files[t];"success"===a.status&&void 0!==a.upload.uuid&&void 0!==a.upload.attachment_id&&(e[a.upload.uuid]=a.upload.attachment_id)}r.val(Object.keys(e).length?JSON.stringify({type:"dropzonejs",attachment_ids:e}):"").trigger("change")},this.on("addedfile",function(a){this.element.classList.add("dz-started"),e("[data-dz-remove]",e(a.previewTemplate)).html(d||t.language("dropzonejs_cancel")),t.dropzonejs_processes++})}},J=t.get_object_meta_value(i,"accept","");""!=J&&(E.acceptedFiles=J);var P=parseInt(t.get_object_meta_value(i,"file_max",0),10);E.maxFiles=s?P>0?P:null:1;var A=parseInt(t.get_object_meta_value(i,"file_max_size",0),10);A>0&&(E.maxFilesize=A);var Q=parseInt(t.get_object_meta_value(i,"file_image_max_width",0),10);Q>0&&(E.resizeWidth=Q);var B=parseInt(t.get_object_meta_value(i,"file_image_max_height",0),10);B>0&&(E.resizeHeight=B);var q="on"==t.get_object_meta_value(i,"file_image_crop","");E.resizeMethod=q?"crop":"contain";var G=parseInt(t.get_object_meta_value(i,"file_image_max_height",100),10);G>0&&(E.resizeQuality=G/100);var K=t.get_object_meta_value(i,"file_image_mime","");""!=K&&(E.resizeMimeType=K);var V=t.get_object_meta_value(i,"file_capture","");""!=V&&(E.capture=V);var X=parseInt(t.get_object_meta_value(i,"file_timeout",""),10);X>0&&(E.timeout=X),l&&(E.dictInvalidFileType=l),n&&(E.dictMaxFilesExceeded=n),_&&(E.dictFileTooBig=_),d&&(E.dictCancelUpload=d),p&&(E.dictCancelUploadConfirmation=p),c&&(E.dictUploadCanceled=c),f&&(E.dictRemoveFile=f),v&&(E.dictRemoveFileConfirmation=v);var Y="#"+o+"-dropzonejs";if(0!==e(Y).length){var Z=new Dropzone(Y,E);e(Y).on("click mousedown mouseup mouseover mouseout touchstart touchend touchmove touchcancel",function(t){e("#"+o).trigger(t.type)}),s&&t.get_object_meta_value(i,"dropzonejs_sortable","on")&&e(Y).sortable({items:".wsf-dropzonejs-preview",cursor:"move",tolerance:"pointer",forceHelperSize:!0,cancel:"[data-dz-remove]",start:function(e,a){t.dropzonejs_index_dragged_from=a.helper.index(),a.placeholder.attr("style",x);var i=a.helper.height(),r=a.helper.outerWidth();a.placeholder.css({width:r+"px",height:i+"px"})},stop:function(e,a){var i=t.dropzonejs_index_dragged_from,r=a.item.index();if(r>=Z.files.length)for(var o=r-Z.files.length;1+o--;)Z.files.push(void 0);Z.files.splice(r,0,Z.files.splice(i,1)[0]),Z.input_update()}}),e(this).attr("data-default-value",e(this).val()),t.form_file_dropzonejs_populate(e(this),!1),t.dropzonejs_processes=0,Z.on("sending",function(e,a,i){ws_form_settings.wsf_nonce&&i.append(ws_form_settings.wsf_nonce_field_name,ws_form_settings.wsf_nonce),ws_form_settings.x_wp_nonce&&i.append("_wpnonce",ws_form_settings.x_wp_nonce),i.append("id",t.form_id),i.append("preview",t.form_canvas_obj[0].hasAttribute("data-preview"))}),Z.on("success",function(a,i,o){if(!a.wsf_preload)if(void 0!==i.error&&!1===i.error){if(this.options.success(a),"object"==typeof i.file_objects&&i.file_objects.length>0){try{var s=JSON.parse(r.val()).attachment_ids}catch(e){s={}}var l=!1;for(var n in i.file_objects)if(i.file_objects.hasOwnProperty(n)){var _=i.file_objects[n],d=_.attachment_id;if(-1===Object.values(s).indexOf(d)){l=d;break}}if(!1===l)return;if(a.upload.attachment_id=l,"object"==typeof _&&void 0!==_.preview&&void 0!==a.previewElement){var p=e("img[data-dz-thumbnail]",e(a.previewElement));p.length&&void 0===p.attr("src")&&p.attr("src",_.preview)}}this.input_update()}else this.options.error(a,i.error_message?i.error_message:t.language("error_file_upload"))}),Z.on("processing",function(){t.form_post_lock("progress",!0,!0)}),Z.on("totaluploadprogress",function(a){u.each(function(){t.form_progress_set_value(e(this),a/100)}),a>99&&e(".wsf-progress",e(this.element)).addClass("wsf-progress-success")}),Z.on("complete",function(e){this.ajax_complete(e)}),Z.on("canceled",function(e){this.ajax_complete(e)}),Z.on("removedfile",function(e){this.input_update(),this.ajax_complete(e)}),Z.on("error",function(a,i){switch(typeof i){case"string":var r=i;try{var o=JSON.parse(i);if(null!==o&&o.error&&o.error_message)r=o.error_message}catch(e){}break;case"object":if(i.error&&i.error_message)r=i.error_message;else r=JSON.stringify(i);break;default:r=t.language("error_file_upload")}e(a.previewElement).find("[data-dz-errormessage]").html(r)});var $=r.attr("disabled");$||($=$||e(this).closest("fieldset").attr("disabled")),$&&Z.disable(),e(this).attr("data-init-file","")}})},e.WS_Form.prototype.form_file_dropzonejs_populate=function(t,a){var i=e("+ .dropzone",t)[0].dropzone;if(i.removeAllFiles(!0),t.val(""),!a){var r=t.attr("data-default-value");if(""!=r){try{var o=JSON.parse(r)}catch(e){o=[]}for(var s in o)if(o.hasOwnProperty(s)){var l=o[s];if(void 0!==l.name){var n={processing:!0,accepted:!0,name:l.name,size:l.size,type:l.type,upload:{uuid:l.uuid,attachment_id:l.attachment_id},status:Dropzone.SUCCESS,wsf_preload:!0},_=void 0!==l.preview?l.preview:l.url;n.upload.uuid||(n.upload.uuid=Dropzone.uuidv4()),i.add_custom_file(n,_,{status:"success"})}}i.input_update()}}},e.WS_Form.prototype.form_file_preview=function(t,a,i,r,o){var s=[],l="<div"+(""!=i?' class="'+this.esc_attr(i)+'"':"")+(""!=r?' style="'+this.esc_attr(r)+'"':"")+">";a.html("");for(var n in t)if(t.hasOwnProperty(n)){var _=t[n];switch(_.type){case"image/apng":case"image/bmp":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/tiff":case"image/webp":case"image/x-icon":s[n]=new FileReader,s[n].wsf_file_index=n,s[n].onload=function(i){var r=this.wsf_file_index,s=i.target.result,n=t[r].name,_=e("<img />");_.attr("src",s),_.attr("alt",n),_.attr("title",n),_.attr("style",o),a.append(l+_[0].outerHTML+"</div>")},s[n].readAsDataURL(_);break;case"video/avi":case"video/mp4":case"video/ogg":case"video/ogm":case"video/ogv":case"video/webm":var d=URL.createObjectURL(_),p=e("<video controls />");p.attr("src",d),p.attr("style",o),p.html(this.language("error_not_supported_video")),a.append(l+p[0].outerHTML+"</div>");break;case"audio/aac":case"audio/aacp":case"audio/flac":case"audio/mp4":case"audio/mpeg":case"audio/ogg":case"audio/wav":case"audio/webm":var c=URL.createObjectURL(_),f=e("<audio controls />");f.attr("src",c),f.attr("style",o+" height: 40px;"),f.html(this.language("error_not_supported_audio")),a.append(l+f[0].outerHTML+"</div>")}}},e.WS_Form.prototype.file_get_count_by_field_id=function(t){var a=e('[name^="'+this.esc_selector(ws_form_settings.field_prefix+t)+'["]',this.form_canvas_obj);if(!a.length)return!1;var i=!1;return a.each(function(){if(e(this).attr("data-file-type")&&"dropzonejs"===e(this).attr("data-file-type")){var t=e(this).closest('[data-type="file"]');if(t){var a=e(".dropzone",t)[0].dropzone;a.files&&(i+=a.files.length)}}else i+=this.files.length}),i}}(jQuery);